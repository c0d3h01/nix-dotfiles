name: "Flake.lock: update Nix dependencies"

on:
  workflow_dispatch: # allows manual triggering
  schedule:
    - cron: '0 0 * * 0' # runs weekly on Sunday at 00:00

jobs:
  nix-flake-update:
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write
      checks: read
      statuses: read

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/determinate-nix-action@v3

      - uses: DeterminateSystems/update-flake-lock@main
        id: pr
        with:
          pr-title: "Update Nix flake inputs"

      - name: Determine merge method
        id: merge
        if: ${{ steps.pr.outputs.pull-request-url != '' }}
        run: |
          repo="${GITHUB_REPOSITORY}"
          data="$(gh api "repos/${repo}")"
          allow_rebase="$(echo "$data" | jq -r '.allow_rebase_merge')"
          allow_merge="$(echo "$data" | jq -r '.allow_merge_commit')"
          allow_squash="$(echo "$data" | jq -r '.allow_squash_merge')"
          allow_auto="$(echo "$data" | jq -r '.allow_auto_merge')"

          if [ "$allow_rebase" = "true" ]; then
            method="rebase"
          elif [ "$allow_merge" = "true" ]; then
            method="merge"
          elif [ "$allow_squash" = "true" ]; then
            method="squash"
          else
            echo "No allowed merge methods for ${repo}" >&2
            exit 1
          fi

          echo "method=$method" >> "$GITHUB_OUTPUT"
          echo "auto=$allow_auto" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Merge Pull Request
        if: ${{ steps.pr.outputs.pull-request-url != '' }}
        run: |
          pr="$PR"
          method="${{ steps.merge.outputs.method }}"
          auto="${{ steps.merge.outputs.auto }}"

          if [ "$auto" = "true" ]; then
            gh pr merge "--$method" --auto --delete-branch "$pr"
          else
            gh pr checks --watch "$pr"
            gh pr merge "--$method" --delete-branch "$pr"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          PR: ${{ steps.pr.outputs.pull-request-url }}
